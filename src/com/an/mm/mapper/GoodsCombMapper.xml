<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="MM.GoodsCombMapper">
	<resultMap id="BaseResultMap" type="com.an.mm.entity.Goods">
		<id column="goods_id" property="goodsId" jdbcType="INTEGER" />
		<result column="goods_code" property="goodsCode" jdbcType="VARCHAR" />
		<result column="goods_barcode" property="goodsBarcode" jdbcType="VARCHAR" />
		<result column="goods_name" property="goodsName" jdbcType="VARCHAR" />
	</resultMap>

	<resultMap id="ItemResultMap" type="com.an.wm.entity.Item">
		<id column="id" property="id" jdbcType="INTEGER" />
		<result column="pn" property="pn" jdbcType="VARCHAR" />
		<result column="barcode" property="barcode" jdbcType="VARCHAR" />
		<result column="name" property="name" jdbcType="VARCHAR" />
		<result column="weight" property="weight" jdbcType="NUMERIC" />
		<result column="comb_quantity" property="combQuantity" jdbcType="NUMERIC" />
	</resultMap>

	<sql id="Example_Where_Clause">
		<where>
			<if test="status != null and status !=''">
				status = #{status}
			</if>
			<if test="status == null">
				status != 'd'
			</if>
			<if test="_SH != null and _SH !=''">
				and (goods_code like concat('%', #{_SH}, '%') or goods_name like concat('%', #{_SH}, '%'))
			</if>
			<if test="brand != null and brand !=''">
				and brand = #{brand}
			</if>
			<if test="goodsCode != null and goodsCode !=''">
				and goods_code like concat('%', #{goodsCode}, '%')
			</if>
			<if test="goodsBarcode != null and goodsBarcode !=''">
				and goods_barcode like concat('%', #{goodsBarcode}, '%')
			</if>
			<if test="goodsName != null and goodsName !=''">
				and goods_name like concat('%', #{goodsName}, '%')
			</if>
			<if test="category != null and category !=''">
				and category like concat(#{category}, '%')
			</if>
		</where>
	</sql>

	<select id="selectByExample" resultMap="BaseResultMap" parameterType="map">
		select goods_id, goods_code, goods_barcode, goods_name, #{combStatus} as status from mm_goods
		where status = 't'
		<if test="goodsCode != null and goodsCode !=''">
			and goods_code like concat('%', #{goodsCode}, '%')
		</if>
		<if test="goodsName != null and goodsName !=''">
			and goods_name like concat('%', #{goodsName}, '%')
		</if>
		<if test="combStatus == 'unComb'">
			and not exists (select 1 from mm_goods_item where goods_id = mm_goods.goods_id)
		</if>
		<if test="_BY != null">order by ${_BY}</if>
	</select>

	<select id="countByExample" resultType="int" parameterType="map">
		select count(1) from MM_GOODS
		where status = 't'
		<if test="goodsCode != null and goodsCode !=''">
			and goods_code like concat('%', #{goodsCode}, '%')
		</if>
		<if test="goodsName != null and goodsName !=''">
			and goods_name like concat('%', #{goodsName}, '%')
		</if>
		<if test="combStatus == 'unComb'">
			and not exists (select 1 from mm_goods_item where goods_id = mm_goods.goods_id)
		</if>
		<if test="_BY != null">order by ${_BY}</if>
	</select>

	<select id="selectItemsByGoodsId" resultMap="ItemResultMap" parameterType="int">
		select i.id, i.pn, i.barcode, i.name, gi.quantity comb_quantity from wm_item i, mm_goods_item gi
		where i.id = gi.item_id
		and gi.goods_id = #{value}
	</select>

	<insert id="insertItem" parameterType="com.an.wm.entity.Item">
		insert into mm_goods_item (goods_id, item_id, quantity, enter_by, enter_at)
		values (#{goodsId}, #{id}, #{combQuantity}, #userId, now())
	</insert>

	<delete id="deleteByPrimaryKey" parameterType="int">
		delete from mm_goods_item where goods_id = #{value}
	</delete>

</mapper>